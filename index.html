<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kana Match Game</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Noto Sans JP',sans-serif;
      background:linear-gradient(135deg,#c31432 0%,#240b36 100%);
      background-image:
        radial-gradient(circle at 20% 50%,rgba(255,107,107,.1) 0%,transparent 50%),
        radial-gradient(circle at 80% 80%,rgba(255,182,193,.1) 0%,transparent 50%),
        linear-gradient(135deg,#c31432 0%,#240b36 100%);
      min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
      padding:20px 10px;overflow:auto;
    }
    .sakura{position:fixed;width:15px;height:15px;background:rgba(255,182,193,.6);border-radius:50% 0 50% 0;animation:fall linear infinite;z-index:1}
    @keyframes fall{to{transform:translateY(100vh) rotate(360deg)}}

    .container{
      background:rgba(255,255,255,.98);border-radius:20px;padding:25px;width:100%;
      max-width:1400px;min-height:90vh;box-shadow:0 20px 60px rgba(0,0,0,.5);
      display:flex;flex-direction:column;border:3px solid #c31432;position:relative;z-index:10
    }
    .header{text-align:center;margin-bottom:15px;border-bottom:3px solid #c31432;padding-bottom:15px}
    h1{color:#c31432;font-size:2.5em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,.1);font-weight:700}
    .subtitle{color:#666;font-size:1em}

    .stats{
      display:flex;justify-content:space-around;margin-bottom:15px;padding:15px;
      background:linear-gradient(135deg,#fff5f5 0%,#ffe6e6 100%);border-radius:10px;border:2px solid #ffb3ba
    }
    .stat{text-align:center}
    .stat-value{font-size:1.8em;font-weight:bold;color:#c31432}
    .stat-label{color:#666;font-size:.85em;margin-top:3px}

    .game-area{
      display:flex;flex-direction:column;gap:20px;width:100%;margin-bottom:20px;flex:1
    }
    .current-area{
      display:flex;justify-content:center
    }
    .column.single{align-items:center;gap:15px;display:flex;flex-direction:column}
    .current-card{
      width:180px;max-width:100%;aspect-ratio:1;background:white;border:3px solid #c31432;border-radius:15px;
      display:flex;align-items:center;justify-content:center;box-shadow:0 10px 25px rgba(195,20,50,.25);
      transition:transform .3s ease, box-shadow .3s ease;cursor:pointer;position:relative
    }
    .current-card:hover{transform:translateY(-4px) scale(1.05);box-shadow:0 14px 30px rgba(195,20,50,.35)}
    .current-card.placeholder{cursor:default;box-shadow:none;border-style:dashed;border-color:#ffb3ba;background:rgba(255,245,245,.8)}
    .placeholder-text{color:#a56;letter-spacing:.5px;text-align:center;font-weight:600}
    .btn-skip{
      background:linear-gradient(135deg,#ff6b6b 0%,#ff8e53 100%);color:#fff;border-color:#ff6b6b;
      padding:10px 22px;border-radius:30px;font-size:.95em
    }
    .btn-skip:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
    .column.katakana{flex:1}
    .column.katakana .column-title{margin-bottom:12px}
    .column.katakana .cards-grid{
      grid-template-columns:repeat(auto-fit,minmax(55px,1fr));
      gap:8px;
      align-content:flex-start;
      justify-items:center;
    }
    .column.katakana .character-card{aspect-ratio:1;border-width:2px;width:100%}
    .column.katakana .character-card .character-main{font-size:1.6em}
    .column{
      display:flex;flex-direction:column;background:linear-gradient(180deg,#fff5f5 0%,#ffffff 100%);
      border-radius:15px;padding:15px;border:2px solid #ffb3ba
    }
    .column-title{
      text-align:center;font-size:1.3em;font-weight:bold;color:#c31432;margin-bottom:10px;padding:10px;
      background:white;border-radius:8px;border:2px solid #c31432;position:sticky;top:0;z-index:5
    }
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(55px,1fr));gap:8px;padding:5px}

    .character-card{
      aspect-ratio:1;background:white;border:2px solid #ffb3ba;border-radius:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      cursor:pointer;transition:all .3s ease;user-select:none;position:relative
    }
    .character-card::before{
      content:'';position:absolute;inset:-2px;background:linear-gradient(45deg,#c31432,#ff6b6b,#c31432);
      border-radius:10px;opacity:0;transition:opacity .3s;z-index:-1
    }
    .character-card:hover::before{opacity:.5}
    .character-main{font-size:2em;font-weight:700;color:#240b36}
    .character-card:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 8px 16px rgba(195,20,50,.3)}
    .character-card.selected{
      border-color:#c31432;background:linear-gradient(135deg,#ffe6e6 0%,#ffb3ba 100%);
      transform:scale(1.1);box-shadow:0 0 20px rgba(195,20,50,.5)
    }
    .character-card.wrong{animation:shake .5s;border-color:#f44336}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    .controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:auto}
    button{
      padding:12px 25px;font-size:1em;border:none;border-radius:8px;cursor:pointer;font-weight:bold;
      transition:all .3s ease;font-family:'Noto Sans JP',sans-serif;border:2px solid transparent
    }
    .btn-all{background:linear-gradient(135deg,#ff9800 0%,#ff6b00 100%);color:white;border-color:#e65100}
    .btn-all:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,152,0,.4)}
    .btn-reset{background:linear-gradient(135deg,#240b36 0%,#4a1a5e 100%);color:white;border-color:#1a0826}
    .btn-reset:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(36,11,54,.4)}

    .message{text-align:center;margin-top:10px;font-size:1.1em;font-weight:bold;min-height:25px}
    .success{color:#4caf50}.error{color:#c31432}

    /* Overlay de cuenta regresiva */
    .overlay{
      position:absolute;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;z-index:20
    }
    .overlay.show{display:flex}
    .countdown{
      color:#fff;font-weight:800;font-size:6rem;text-shadow:0 8px 24px rgba(0,0,0,.6);
      animation:pop .6s ease-in-out
    }
    @keyframes pop{0%{transform:scale(.6);opacity:.2}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}

    /* Timer en el header */
    .timer{
      margin-top:8px;color:#240b36;font-weight:700;font-variant-numeric:tabular-nums;
      display:inline-block;padding:6px 12px;border:2px solid #c31432;border-radius:10px;background:#fff
    }
    .timer.stopped{opacity:.7}

    @media (max-width:768px){
      h1{font-size:1.8em}.stats{padding:10px}.stat-value{font-size:1.4em}.stat-label{font-size:.75em}
      .column-title{font-size:1.1em;padding:8px}.character-main{font-size:1.5em}
      .cards-grid{grid-template-columns:repeat(auto-fit,minmax(50px,1fr));gap:6px}
      .current-card{width:150px}
      button{padding:10px 20px;font-size:.9em}
    }
    @media (max-width:480px){
      .container{padding:15px} h1{font-size:1.5em}.subtitle{font-size:.85em}
      .cards-grid{grid-template-columns:repeat(auto-fit,minmax(45px,1fr));gap:5px}
      .character-main{font-size:1.3em}.game-area{gap:15px}
      .current-card{width:130px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå∏ „Åã„Å™ Match üå∏</h1>
      <p class="subtitle">„Å≤„Çâ„Åå„Å™ ‚áÑ „Ç´„Çø„Ç´„Éä | Toca para escuchar</p>
      <div id="timer" class="timer stopped">00:00.00</div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Puntos</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="matches">0</div>
        <div class="stat-label">Aciertos</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="attempts">0</div>
        <div class="stat-label">Intentos</div>
      </div>
    </div>

    <div class="game-area">
      <div class="current-area">
        <div class="column single">
          <div class="column-title">„Å≤„Çâ„Åå„Å™</div>
          <div id="current-hiragana-card" class="current-card placeholder">
            <span class="placeholder-text">Presiona "Iniciar"</span>
          </div>
          <button id="skipBtn" class="btn-skip" disabled>Cambiar kana</button>
        </div>
      </div>
      <div class="column katakana">
        <div class="column-title">„Ç´„Çø„Ç´„Éä</div>
        <div class="cards-grid" id="katakana-column"></div>
      </div>
    </div>

    <div class="controls">
      <!-- Cambiado a "Iniciar" -->
      <button id="startBtn" class="btn-all" onclick="startAllMode()">Iniciar</button>
      <button class="btn-reset" onclick="resetAll()">Reiniciar</button>
    </div>

    <div class="message" id="message"></div>

    <!-- Overlay de cuenta regresiva -->
    <div id="overlay" class="overlay">
      <div id="countdown" class="countdown">3</div>
    </div>
  </div>

  <script>
    // Sakura
    for (let i = 0; i < 15; i++) {
      const sakura = document.createElement('div');
      sakura.className = 'sakura';
      sakura.style.left = Math.random() * 100 + '%';
      sakura.style.animationDuration = (Math.random() * 3 + 5) + 's';
      sakura.style.animationDelay = Math.random() * 5 + 's';
      sakura.style.opacity = Math.random() * 0.5 + 0.3;
      document.body.appendChild(sakura);
    }

    // Datos de kana
    const allKanaData = [
      { hiragana:'„ÅÇ', katakana:'„Ç¢', romaji:'a' }, { hiragana:'„ÅÑ', katakana:'„Ç§', romaji:'i' },
      { hiragana:'„ÅÜ', katakana:'„Ç¶', romaji:'u' }, { hiragana:'„Åà', katakana:'„Ç®', romaji:'e' },
      { hiragana:'„Åä', katakana:'„Ç™', romaji:'o' }, { hiragana:'„Åã', katakana:'„Ç´', romaji:'ka' },
      { hiragana:'„Åç', katakana:'„Ç≠', romaji:'ki' }, { hiragana:'„Åè', katakana:'„ÇØ', romaji:'ku' },
      { hiragana:'„Åë', katakana:'„Ç±', romaji:'ke' }, { hiragana:'„Åì', katakana:'„Ç≥', romaji:'ko' },
      { hiragana:'„Åï', katakana:'„Çµ', romaji:'sa' }, { hiragana:'„Åó', katakana:'„Ç∑', romaji:'shi' },
      { hiragana:'„Åô', katakana:'„Çπ', romaji:'su' }, { hiragana:'„Åõ', katakana:'„Çª', romaji:'se' },
      { hiragana:'„Åù', katakana:'„ÇΩ', romaji:'so' }, { hiragana:'„Åü', katakana:'„Çø', romaji:'ta' },
      { hiragana:'„Å°', katakana:'„ÉÅ', romaji:'chi' }, { hiragana:'„Å§', katakana:'„ÉÑ', romaji:'tsu' },
      { hiragana:'„Å¶', katakana:'„ÉÜ', romaji:'te' }, { hiragana:'„Å®', katakana:'„Éà', romaji:'to' },
      { hiragana:'„Å™', katakana:'„Éä', romaji:'na' }, { hiragana:'„Å´', katakana:'„Éã', romaji:'ni' },
      { hiragana:'„Å¨', katakana:'„Éå', romaji:'nu' }, { hiragana:'„Å≠', katakana:'„Éç', romaji:'ne' },
      { hiragana:'„ÅÆ', katakana:'„Éé', romaji:'no' }, { hiragana:'„ÅØ', katakana:'„Éè', romaji:'ha' },
      { hiragana:'„Å≤', katakana:'„Éí', romaji:'hi' }, { hiragana:'„Åµ', katakana:'„Éï', romaji:'fu' },
      { hiragana:'„Å∏', katakana:'„Éò', romaji:'he' }, { hiragana:'„Åª', katakana:'„Éõ', romaji:'ho' },
      { hiragana:'„Åæ', katakana:'„Éû', romaji:'ma' }, { hiragana:'„Åø', katakana:'„Éü', romaji:'mi' },
      { hiragana:'„ÇÄ', katakana:'„É†', romaji:'mu' }, { hiragana:'„ÇÅ', katakana:'„É°', romaji:'me' },
      { hiragana:'„ÇÇ', katakana:'„É¢', romaji:'mo' }, { hiragana:'„ÇÑ', katakana:'„É§', romaji:'ya' },
      { hiragana:'„ÇÜ', katakana:'„É¶', romaji:'yu' }, { hiragana:'„Çà', katakana:'„É®', romaji:'yo' },
      { hiragana:'„Çâ', katakana:'„É©', romaji:'ra' }, { hiragana:'„Çä', katakana:'„É™', romaji:'ri' },
      { hiragana:'„Çã', katakana:'„É´', romaji:'ru' }, { hiragana:'„Çå', katakana:'„É¨', romaji:'re' },
      { hiragana:'„Çç', katakana:'„É≠', romaji:'ro' }, { hiragana:'„Çè', katakana:'„ÉØ', romaji:'wa' },
      { hiragana:'„Çí', katakana:'„É≤', romaji:'wo' }, { hiragana:'„Çì', katakana:'„É≥', romaji:'n' }
    ];

    // Estado
    let gameState = {
      currentHiragana: null,
      remainingHiragana: [],
      katakanaOrder: [],
      matchedPairs: [],
      totalPairs: allKanaData.length,
      score: 0,
      matches: 0,
      attempts: 0,
      running: false,
      hasStarted: false
    };

    // Timer
    let timerId = null;
    let startTime = 0;

    function formatTime(ms){
      const minutes = Math.floor(ms/60000);
      const seconds = Math.floor((ms%60000)/1000);
      const centis  = Math.floor((ms%1000)/10);
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(centis).padStart(2,'0')}`;
    }

    function startTimer(){
      startTime = performance.now();
      const timerEl = document.getElementById('timer');
      timerEl.classList.remove('stopped');
      gameState.running = true;

      timerId = requestAnimationFrame(function tick(now){
        const elapsed = now - startTime;
        timerEl.textContent = formatTime(elapsed);
        if(gameState.running){ timerId = requestAnimationFrame(tick); }
      });
    }

    function stopTimer(){
      gameState.running = false;
      const timerEl = document.getElementById('timer');
      timerEl.classList.add('stopped');
      if(timerId){ cancelAnimationFrame(timerId); timerId = null; }
    }

    // ======= Voz: usar OTRA voz japonesa + retardo =======
    let cachedVoices = [];
    let speakTimeout = null;
    const SPEAK_DELAY_MS = 500; // retardo antes de pronunciar

    function refreshVoices(){
      if(!('speechSynthesis' in window)) return;
      cachedVoices = speechSynthesis.getVoices() || [];
    }
    if('speechSynthesis' in window){
      speechSynthesis.onvoiceschanged = refreshVoices;
      refreshVoices();
    }

    function pickAlternateJapaneseVoice(){
      // Filtra voces japonesas
      const jpVoices = cachedVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ja'));
      if (jpVoices.length === 0) return null;
      // Si hay m√°s de una, elige la √∫ltima (distinta a la primera "t√≠pica")
      if (jpVoices.length > 1) return jpVoices[jpVoices.length - 1];
      // Si solo hay una, usa esa (no hay alternativa real)
      return jpVoices[0];
    }

    function speakKana(kanaChar){
      if(!('speechSynthesis' in window)) return;

      // Cancela cualquier cola/retardo previo
      if (speakTimeout) { clearTimeout(speakTimeout); speakTimeout = null; }
      speechSynthesis.cancel();

      speakTimeout = setTimeout(()=>{
        const utter = new SpeechSynthesisUtterance(kanaChar);
        utter.lang = 'ja-JP';
        utter.rate = 0.9;
        utter.pitch = 1.0;
        utter.volume = 1.0;

        const alt = pickAlternateJapaneseVoice();
        if (alt) utter.voice = alt;

        speechSynthesis.speak(utter);
      }, SPEAK_DELAY_MS);
    }
    // ================================================

    // Util
    function shuffle(array){
      const a = [...array];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // Render
    function renderCurrentHiragana(){
      const card = document.getElementById('current-hiragana-card');
      const skipBtn = document.getElementById('skipBtn');

      if(gameState.currentHiragana){
        card.classList.remove('placeholder');
        card.innerHTML = `<div class="character-main">${gameState.currentHiragana.hiragana}</div>`;
        card.onclick = ()=>{
          speakKana(gameState.currentHiragana.hiragana);
        };
      }else{
        card.classList.add('placeholder');
        const text = gameState.hasStarted ? '¬°Kana completados! üéâ' : 'Presiona "Iniciar"';
        card.innerHTML = `<span class="placeholder-text">${text}</span>`;
        card.onclick = null;
      }

      skipBtn.disabled = !gameState.currentHiragana || gameState.remainingHiragana.length <= 1;
    }

    function renderKatakana(list){
      const kCol = document.getElementById('katakana-column');
      kCol.innerHTML = '';

      list.forEach(kana=>{
        const card = document.createElement('div');
        card.className = 'character-card';
        card.innerHTML = `<div class="character-main">${kana.katakana}</div>`;
        card.dataset.romaji = kana.romaji;
        card.dataset.char = kana.katakana;
        card.onclick = ()=>{
          if(!gameState.running) return;
          speakKana(card.dataset.char);
          handleKatakanaSelection(kana, card);
        };
        kCol.appendChild(card);
      });
    }

    function clearKatakanaSelection(){
      document.querySelectorAll('#katakana-column .character-card').forEach(c=>c.classList.remove('selected'));
    }

    function handleKatakanaSelection(kana, card){
      if(!gameState.currentHiragana) return;

      clearKatakanaSelection();
      card.classList.add('selected');

      gameState.attempts++;
      updateStats();

      if(kana.romaji === gameState.currentHiragana.romaji){
        gameState.matchedPairs.push(kana.romaji);
        gameState.score += 10;
        gameState.matches++;
        showMessage('‚úì ¬°Perfecto! Ê≠£Ëß£ÔºÅ','success');

        gameState.katakanaOrder = gameState.katakanaOrder.filter(k => k.romaji !== kana.romaji);
        renderKatakana(gameState.katakanaOrder);
        advanceToNextHiragana();

        if(gameState.matches === gameState.totalPairs){
          setTimeout(()=>{
            showMessage('üéâ ¬°Completado! „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ','success');
            stopTimer();
            renderCurrentHiragana();
          }, 400);
        }
      }else{
        gameState.score = Math.max(0, gameState.score - 2);
        card.classList.add('wrong');
        setTimeout(()=>{ card.classList.remove('wrong','selected'); }, 600);
        showMessage('‚úó ¬°Intenta de nuevo! „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ','error');
      }

      updateStats();
    }

    function advanceToNextHiragana(){
      if(gameState.remainingHiragana.length){
        gameState.remainingHiragana.shift();
      }

      if(gameState.remainingHiragana.length){
        gameState.currentHiragana = gameState.remainingHiragana[0];
      }else{
        gameState.currentHiragana = null;
      }

      clearKatakanaSelection();
      renderCurrentHiragana();
    }

    function cycleCurrentHiragana(){
      if(!gameState.running) return;
      if(gameState.remainingHiragana.length <= 1) return;

      const next = gameState.remainingHiragana.shift();
      gameState.remainingHiragana.push(next);
      gameState.currentHiragana = gameState.remainingHiragana[0];
      clearKatakanaSelection();
      renderCurrentHiragana();
      showMessage('Kana cambiado. ¬°Encuentra su katakana!');
    }

    function updateStats(){
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('matches').textContent = gameState.matches;
      document.getElementById('attempts').textContent = gameState.attempts;
    }

    function showMessage(text,type=''){
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = 'message '+type;
    }

    // Flujo "Iniciar" (antes "Todos (46)") con cuenta regresiva
    function startAllMode(){
      resetAllStatsOnly();
      countdownThen(()=>{
        gameState.hasStarted = true;
        gameState.totalPairs = allKanaData.length;
        gameState.remainingHiragana = shuffle(allKanaData);
        gameState.currentHiragana = gameState.remainingHiragana[0] || null;
        gameState.katakanaOrder = shuffle(allKanaData);
        renderCurrentHiragana();
        renderKatakana(gameState.katakanaOrder);
        startTimer();
        showMessage('¬°Encuentra el katakana que corresponde!');
      });
    }

    // Cuenta regresiva 3-2-1-YA
    function countdownThen(cb){
      const overlay = document.getElementById('overlay');
      const label = document.getElementById('countdown');
      overlay.classList.add('show');

      const steps = ['3','2','1','YA!'];
      let i = 0;
      label.textContent = steps[i];
      const iv = setInterval(()=>{
        i++;
        if(i < steps.length){
          label.textContent = steps[i];
          label.classList.remove('countdown'); void label.offsetWidth; label.classList.add('countdown');
        }else{
          clearInterval(iv);
          overlay.classList.remove('show');
          cb && cb();
        }
      }, 800);
    }

    // Reset total (sin empezar juego)
    function resetAll(){
      resetAllStatsOnly();
      showMessage('¬°Listo! Presiona "Iniciar" para jugar.');
    }

    function resetAllStatsOnly(){
      stopTimer();
      gameState.currentHiragana = null;
      gameState.remainingHiragana = [];
      gameState.katakanaOrder = [];
      gameState.matchedPairs = [];
      gameState.totalPairs = allKanaData.length;
      gameState.score = 0; gameState.matches = 0; gameState.attempts = 0;
      gameState.hasStarted = false;
      updateStats();
      renderKatakana([]);
      renderCurrentHiragana();
      document.getElementById('timer').textContent = '00:00.00';
    }

    // Mensaje inicial
    showMessage('Presiona "Iniciar" para comenzar con cuenta regresiva.');
    renderCurrentHiragana();

    document.getElementById('skipBtn').addEventListener('click', cycleCurrentHiragana);
  </script>
</body>
</html>
