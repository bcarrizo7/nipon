<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kana Match Game</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Noto Sans JP',sans-serif;
      background:linear-gradient(135deg,#c31432 0%,#240b36 100%);
      background-image:
        radial-gradient(circle at 20% 50%,rgba(255,107,107,.1) 0%,transparent 50%),
        radial-gradient(circle at 80% 80%,rgba(255,182,193,.1) 0%,transparent 50%),
        linear-gradient(135deg,#c31432 0%,#240b36 100%);
      min-height:100vh;display:flex;justify-content:center;align-items:flex-start;
      padding:20px 10px;overflow:auto;
    }
    .sakura{position:fixed;width:15px;height:15px;background:rgba(255,182,193,.6);border-radius:50% 0 50% 0;animation:fall linear infinite;z-index:1}
    @keyframes fall{to{transform:translateY(100vh) rotate(360deg)}}

    .container{
      background:rgba(255,255,255,.98);border-radius:20px;padding:25px;width:100%;
      max-width:1400px;min-height:90vh;box-shadow:0 20px 60px rgba(0,0,0,.5);
      display:flex;flex-direction:column;border:3px solid #c31432;position:relative;z-index:10
    }
    .header{text-align:center;margin-bottom:15px;border-bottom:3px solid #c31432;padding-bottom:15px}
    h1{color:#c31432;font-size:2.5em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,.1);font-weight:700}
    .subtitle{color:#666;font-size:1em}

    .stats{
      display:flex;justify-content:space-around;margin-bottom:15px;padding:15px;
      background:linear-gradient(135deg,#fff5f5 0%,#ffe6e6 100%);border-radius:10px;border:2px solid #ffb3ba
    }
    .stat{text-align:center}
    .stat-value{font-size:1.8em;font-weight:bold;color:#c31432}
    .stat-label{color:#666;font-size:.85em;margin-top:3px}

    .game-area{
      display:flex;flex-direction:column;gap:20px;width:100%;margin-bottom:20px;flex:1
    }
    .current-area{
      display:flex;justify-content:center
    }
    .column.single{align-items:center;gap:15px;display:flex;flex-direction:column}
    .current-card-row{
      display:flex;align-items:center;gap:12px
    }
    .current-card-row .btn-skip{
      align-self:stretch;display:flex;align-items:center;justify-content:center;white-space:nowrap
    }
    .current-card{
      width:180px;max-width:100%;aspect-ratio:1;background:white;border:3px solid #c31432;border-radius:15px;
      display:flex;align-items:center;justify-content:center;box-shadow:0 10px 25px rgba(195,20,50,.25);
      transition:transform .3s ease, box-shadow .3s ease;cursor:pointer;position:relative
    }
    .current-card:hover{transform:translateY(-4px) scale(1.05);box-shadow:0 14px 30px rgba(195,20,50,.35)}
    .current-card.placeholder{cursor:default;box-shadow:none;border-style:dashed;border-color:#ffb3ba;background:rgba(255,245,245,.8)}
    .placeholder-text{color:#a56;letter-spacing:.5px;text-align:center;font-weight:600}
    .btn-skip{
      background:linear-gradient(135deg,#ff6b6b 0%,#ff8e53 100%);color:#fff;border-color:#ff6b6b;
      padding:10px 22px;border-radius:30px;font-size:.95em
    }
    .btn-skip:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
    .column.options{flex:1}
    .column.options .column-title{margin-bottom:12px}
    .column.options .cards-grid{
      grid-template-columns:repeat(auto-fit,minmax(55px,1fr));
      gap:8px;
      align-content:flex-start;
      justify-items:center;
    }
    .column.options .character-card{aspect-ratio:1;border-width:2px;width:100%}
    .column.options .character-card .character-main{font-size:1.6em}
    .column{
      display:flex;flex-direction:column;background:linear-gradient(180deg,#fff5f5 0%,#ffffff 100%);
      border-radius:15px;padding:15px;border:2px solid #ffb3ba
    }
    .column-title{
      text-align:center;font-size:1.3em;font-weight:bold;color:#c31432;margin-bottom:10px;padding:10px;
      background:white;border-radius:8px;border:2px solid #c31432;position:sticky;top:0;z-index:5
    }
    .cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(55px,1fr));gap:8px;padding:5px}

    .character-card{
      aspect-ratio:1;background:white;border:2px solid #ffb3ba;border-radius:10px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      cursor:pointer;transition:all .3s ease;user-select:none;position:relative
    }
    .character-card::before{
      content:'';position:absolute;inset:-2px;background:linear-gradient(45deg,#c31432,#ff6b6b,#c31432);
      border-radius:10px;opacity:0;transition:opacity .3s;z-index:-1
    }
    .character-card:hover::before{opacity:.5}
    .character-main{font-size:2em;font-weight:700;color:#240b36}
    .character-card:hover{transform:translateY(-3px) scale(1.05);box-shadow:0 8px 16px rgba(195,20,50,.3)}
    .character-card.selected{
      border-color:#c31432;background:linear-gradient(135deg,#ffe6e6 0%,#ffb3ba 100%);
      transform:scale(1.1);box-shadow:0 0 20px rgba(195,20,50,.5)
    }
    .current-card.correct,.character-card.correct{
      background:linear-gradient(135deg,#d4edda 0%,#a5d6a7 100%);
      border-color:#4caf50 !important;
      box-shadow:0 0 25px rgba(76,175,80,.45);
      color:#1b5e20
    }
    .character-card.correct{transform:scale(1.08)}
    .character-card.wrong{animation:shake .5s;border-color:#f44336}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    .controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:auto}
    button{
      padding:12px 25px;font-size:1em;border:none;border-radius:8px;cursor:pointer;font-weight:bold;
      transition:all .3s ease;font-family:'Noto Sans JP',sans-serif;border:2px solid transparent
    }
    .btn-all{background:linear-gradient(135deg,#ff9800 0%,#ff6b00 100%);color:white;border-color:#e65100}
    .btn-all:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,152,0,.4)}
    .btn-reset{background:linear-gradient(135deg,#240b36 0%,#4a1a5e 100%);color:white;border-color:#1a0826}
    .btn-reset:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(36,11,54,.4)}
    .btn-mode{background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:white;border-color:#1b5e20}
    .btn-mode:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(76,175,80,.45)}

    .message{text-align:center;margin-top:10px;font-size:1.1em;font-weight:bold;min-height:25px}
    .success{color:#4caf50}.error{color:#c31432}

    /* Overlay de cuenta regresiva */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;z-index:999;
      padding:20px;
    }
    .overlay.show{display:flex}
    .countdown{
      color:#fff;font-weight:800;font-size:6rem;text-shadow:0 8px 24px rgba(0,0,0,.6);
    }
    .countdown.is-animating{
      animation:pop .6s ease-in-out;
    }
    @keyframes pop{0%{transform:scale(.6);opacity:.2}70%{transform:scale(1.1);opacity:1}100%{transform:scale(1)}}

    /* Timer en el header */
    .timer{
      margin-top:8px;color:#240b36;font-weight:700;font-variant-numeric:tabular-nums;
      display:inline-block;padding:6px 12px;border:2px solid #c31432;border-radius:10px;background:#fff
    }
    .timer.stopped{opacity:.7}

    @media (max-width:768px){
      h1{font-size:1.8em}.stats{padding:10px}.stat-value{font-size:1.4em}.stat-label{font-size:.75em}
      .column-title{font-size:1.1em;padding:8px}.character-main{font-size:1.5em}
      .cards-grid{grid-template-columns:repeat(auto-fit,minmax(50px,1fr));gap:6px}
      .current-card{width:150px}
      .current-card-row{width:100%;justify-content:space-between}
      .btn-skip{padding:10px 18px;border-radius:20px}
      button{padding:10px 20px;font-size:.9em}
      .current-area{position:sticky;top:0;z-index:25;background:rgba(255,255,255,.95);padding:10px 0;margin:-10px 0 0}
    }
    @media (max-width:480px){
      .container{padding:15px} h1{font-size:1.5em}.subtitle{font-size:.85em}
      .cards-grid{grid-template-columns:repeat(auto-fit,minmax(45px,1fr));gap:5px}
      .character-main{font-size:1.3em}.game-area{gap:15px}
      .current-card{width:130px}
      .current-card-row{flex-wrap:wrap;justify-content:center}
      .btn-skip{width:auto;min-width:140px}
      .countdown{font-size:4rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå∏ „Åã„Å™ Match üå∏</h1>
      <p class="subtitle">„Å≤„Çâ„Åå„Å™ ‚áÑ „Ç´„Çø„Ç´„Éä | Toca para escuchar</p>
      <div id="timer" class="timer stopped">00:00.00</div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="score">0</div>
        <div class="stat-label">Puntos</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="matches">0</div>
        <div class="stat-label">Aciertos</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="attempts">0</div>
        <div class="stat-label">Intentos</div>
      </div>
    </div>

    <div class="game-area">
      <div class="current-area">
        <div class="column single">
          <div class="column-title" id="target-column-title">„Å≤„Çâ„Åå„Å™</div>
          <div class="current-card-row">
            <div id="current-target-card" class="current-card placeholder">
              <span class="placeholder-text">Presiona "Iniciar"</span>
            </div>
            <button id="skipBtn" class="btn-skip" disabled>Cambiar kana</button>
          </div>
        </div>
      </div>
      <div class="column options">
        <div class="column-title" id="options-column-title">„Ç´„Çø„Ç´„Éä</div>
        <div class="cards-grid" id="options-column"></div>
      </div>
    </div>

    <div class="controls">
      <!-- Cambiado a "Iniciar" -->
      <button id="startBtn" class="btn-all" onclick="startAllMode()">Iniciar</button>
      <button id="modeToggleBtn" class="btn-mode" onclick="toggleMode()" title="Cambiar entre „ÅÇ‚Üí„Ç¢ y „Ç¢‚Üí„ÅÇ">üéÆ „ÅÇ‚Üí„Ç¢</button>
      <button class="btn-reset" onclick="resetAll()">Reiniciar</button>
    </div>

    <div class="message" id="message"></div>

    <!-- Overlay de cuenta regresiva -->
    <div id="overlay" class="overlay">
      <div id="countdown" class="countdown">3</div>
    </div>
  </div>

  <script>
    // Sakura
    for (let i = 0; i < 15; i++) {
      const sakura = document.createElement('div');
      sakura.className = 'sakura';
      sakura.style.left = Math.random() * 100 + '%';
      sakura.style.animationDuration = (Math.random() * 3 + 5) + 's';
      sakura.style.animationDelay = Math.random() * 5 + 's';
      sakura.style.opacity = Math.random() * 0.5 + 0.3;
      document.body.appendChild(sakura);
    }

    // Datos de kana
    const allKanaData = [
      { hiragana:'„ÅÇ', katakana:'„Ç¢', romaji:'a' }, { hiragana:'„ÅÑ', katakana:'„Ç§', romaji:'i' },
      { hiragana:'„ÅÜ', katakana:'„Ç¶', romaji:'u' }, { hiragana:'„Åà', katakana:'„Ç®', romaji:'e' },
      { hiragana:'„Åä', katakana:'„Ç™', romaji:'o' }, { hiragana:'„Åã', katakana:'„Ç´', romaji:'ka' },
      { hiragana:'„Åç', katakana:'„Ç≠', romaji:'ki' }, { hiragana:'„Åè', katakana:'„ÇØ', romaji:'ku' },
      { hiragana:'„Åë', katakana:'„Ç±', romaji:'ke' }, { hiragana:'„Åì', katakana:'„Ç≥', romaji:'ko' },
      { hiragana:'„Åï', katakana:'„Çµ', romaji:'sa' }, { hiragana:'„Åó', katakana:'„Ç∑', romaji:'shi' },
      { hiragana:'„Åô', katakana:'„Çπ', romaji:'su' }, { hiragana:'„Åõ', katakana:'„Çª', romaji:'se' },
      { hiragana:'„Åù', katakana:'„ÇΩ', romaji:'so' }, { hiragana:'„Åü', katakana:'„Çø', romaji:'ta' },
      { hiragana:'„Å°', katakana:'„ÉÅ', romaji:'chi' }, { hiragana:'„Å§', katakana:'„ÉÑ', romaji:'tsu' },
      { hiragana:'„Å¶', katakana:'„ÉÜ', romaji:'te' }, { hiragana:'„Å®', katakana:'„Éà', romaji:'to' },
      { hiragana:'„Å™', katakana:'„Éä', romaji:'na' }, { hiragana:'„Å´', katakana:'„Éã', romaji:'ni' },
      { hiragana:'„Å¨', katakana:'„Éå', romaji:'nu' }, { hiragana:'„Å≠', katakana:'„Éç', romaji:'ne' },
      { hiragana:'„ÅÆ', katakana:'„Éé', romaji:'no' }, { hiragana:'„ÅØ', katakana:'„Éè', romaji:'ha' },
      { hiragana:'„Å≤', katakana:'„Éí', romaji:'hi' }, { hiragana:'„Åµ', katakana:'„Éï', romaji:'fu' },
      { hiragana:'„Å∏', katakana:'„Éò', romaji:'he' }, { hiragana:'„Åª', katakana:'„Éõ', romaji:'ho' },
      { hiragana:'„Åæ', katakana:'„Éû', romaji:'ma' }, { hiragana:'„Åø', katakana:'„Éü', romaji:'mi' },
      { hiragana:'„ÇÄ', katakana:'„É†', romaji:'mu' }, { hiragana:'„ÇÅ', katakana:'„É°', romaji:'me' },
      { hiragana:'„ÇÇ', katakana:'„É¢', romaji:'mo' }, { hiragana:'„ÇÑ', katakana:'„É§', romaji:'ya' },
      { hiragana:'„ÇÜ', katakana:'„É¶', romaji:'yu' }, { hiragana:'„Çà', katakana:'„É®', romaji:'yo' },
      { hiragana:'„Çâ', katakana:'„É©', romaji:'ra' }, { hiragana:'„Çä', katakana:'„É™', romaji:'ri' },
      { hiragana:'„Çã', katakana:'„É´', romaji:'ru' }, { hiragana:'„Çå', katakana:'„É¨', romaji:'re' },
      { hiragana:'„Çç', katakana:'„É≠', romaji:'ro' }, { hiragana:'„Çè', katakana:'„ÉØ', romaji:'wa' },
      { hiragana:'„Çí', katakana:'„É≤', romaji:'wo' }, { hiragana:'„Çì', katakana:'„É≥', romaji:'n' }
    ];

    const MODE_CONFIG = {
      'hiragana-to-katakana': {
        targetTitle: '„Å≤„Çâ„Åå„Å™',
        optionsTitle: '„Ç´„Çø„Ç´„Éä',
        startMessage: '¬°Encuentra el katakana que corresponde!',
        cycleMessage: 'Kana cambiado. ¬°Encuentra su katakana!',
        toggleLabel: 'üéÆ „ÅÇ‚Üí„Ç¢'
      },
      'katakana-to-hiragana': {
        targetTitle: '„Ç´„Çø„Ç´„Éä',
        optionsTitle: '„Å≤„Çâ„Åå„Å™',
        startMessage: '¬°Encuentra el hiragana correcto!',
        cycleMessage: 'Kana cambiado. ¬°Encuentra su hiragana!',
        toggleLabel: 'üéÆ „Ç¢‚Üí„ÅÇ'
      }
    };

    // Estado
    let gameState = {
      mode: 'hiragana-to-katakana',
      currentPair: null,
      remainingPairs: [],
      optionOrder: [],
      matchedPairs: [],
      totalPairs: allKanaData.length,
      score: 0,
      matches: 0,
      attempts: 0,
      running: false,
      hasStarted: false
    };

    // Timer
    let timerId = null;
    let startTime = 0;

    function formatTime(ms){
      const minutes = Math.floor(ms/60000);
      const seconds = Math.floor((ms%60000)/1000);
      const centis  = Math.floor((ms%1000)/10);
      return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(centis).padStart(2,'0')}`;
    }

    function startTimer(){
      startTime = performance.now();
      const timerEl = document.getElementById('timer');
      timerEl.classList.remove('stopped');
      gameState.running = true;

      timerId = requestAnimationFrame(function tick(now){
        const elapsed = now - startTime;
        timerEl.textContent = formatTime(elapsed);
        if(gameState.running){ timerId = requestAnimationFrame(tick); }
      });
    }

    function stopTimer(){
      gameState.running = false;
      const timerEl = document.getElementById('timer');
      timerEl.classList.add('stopped');
      if(timerId){ cancelAnimationFrame(timerId); timerId = null; }
    }

    // ======= Voz: usar OTRA voz japonesa + retardo =======
    let cachedVoices = [];
    let speakTimeout = null;
    const SPEAK_DELAY_MS = 500; // retardo antes de pronunciar
    let countdownTimeouts = [];
    function clearCountdownTimers(){
      countdownTimeouts.forEach(t => clearTimeout(t));
      countdownTimeouts = [];
    }

    function refreshVoices(){
      if(!('speechSynthesis' in window)) return;
      cachedVoices = speechSynthesis.getVoices() || [];
    }
    if('speechSynthesis' in window){
      speechSynthesis.onvoiceschanged = refreshVoices;
      refreshVoices();
    }

    function pickAlternateJapaneseVoice(){
      // Filtra voces japonesas
      const jpVoices = cachedVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith('ja'));
      if (jpVoices.length === 0) return null;
      // Si hay m√°s de una, elige la √∫ltima (distinta a la primera "t√≠pica")
      if (jpVoices.length > 1) return jpVoices[jpVoices.length - 1];
      // Si solo hay una, usa esa (no hay alternativa real)
      return jpVoices[0];
    }

    function speakKana(kanaChar){
      if(!('speechSynthesis' in window)) return;

      // Cancela cualquier cola/retardo previo
      if (speakTimeout) { clearTimeout(speakTimeout); speakTimeout = null; }
      speechSynthesis.cancel();

      speakTimeout = setTimeout(()=>{
        const utter = new SpeechSynthesisUtterance(kanaChar);
        utter.lang = 'ja-JP';
        utter.rate = 0.9;
        utter.pitch = 1.0;
        utter.volume = 1.0;

        const alt = pickAlternateJapaneseVoice();
        if (alt) utter.voice = alt;

        speechSynthesis.speak(utter);
      }, SPEAK_DELAY_MS);
    }
    // ================================================

    function announceCurrentTarget(force = false){
      if(!gameState.currentPair) return;
      if(!force && !gameState.running) return;
      speakKana(getTargetChar(gameState.currentPair));
    }

    // Sonido de acierto
    let audioCtx = null;
    function getAudioContext(){
      if(!audioCtx){
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if(Ctx){ audioCtx = new Ctx(); }
      }
      return audioCtx;
    }

    function playSuccessTone(){
      const ctx = getAudioContext();
      if(!ctx) return;
      if(ctx.state === 'suspended'){ ctx.resume(); }

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = 'triangle';
      osc.frequency.setValueAtTime(660, ctx.currentTime);

      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);

      osc.connect(gain).connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.4);
    }

    // Util
    function shuffle(array){
      const a = [...array];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // Render
    function getTargetChar(kana){
      return gameState.mode === 'hiragana-to-katakana' ? kana.hiragana : kana.katakana;
    }

    function getOptionChar(kana){
      return gameState.mode === 'hiragana-to-katakana' ? kana.katakana : kana.hiragana;
    }

    function renderCurrentTarget(){
      const card = document.getElementById('current-target-card');
      const skipBtn = document.getElementById('skipBtn');
      const config = MODE_CONFIG[gameState.mode];
      document.getElementById('target-column-title').textContent = config.targetTitle;

      if(gameState.currentPair){
        card.classList.remove('placeholder','correct');
        card.innerHTML = `<div class="character-main">${getTargetChar(gameState.currentPair)}</div>`;
        card.onclick = ()=>{
          speakKana(getTargetChar(gameState.currentPair));
        };
      }else{
        card.classList.add('placeholder');
        card.classList.remove('correct');
        const text = gameState.hasStarted ? '¬°Kana completados! üéâ' : 'Presiona "Iniciar"';
        card.innerHTML = `<span class="placeholder-text">${text}</span>`;
        card.onclick = null;
      }

      skipBtn.disabled = !gameState.currentPair || gameState.remainingPairs.length <= 1;
    }

    function renderOptions(list){
      const column = document.getElementById('options-column');
      const config = MODE_CONFIG[gameState.mode];
      document.getElementById('options-column-title').textContent = config.optionsTitle;
      column.innerHTML = '';

      list.forEach(kana=>{
        const card = document.createElement('div');
        card.className = 'character-card';
        card.innerHTML = `<div class="character-main">${getOptionChar(kana)}</div>`;
        card.dataset.romaji = kana.romaji;
        card.dataset.char = getOptionChar(kana);
        card.onclick = ()=>{
          if(!gameState.running) return;
          speakKana(card.dataset.char);
          handleOptionSelection(kana, card);
        };
        column.appendChild(card);
      });
    }

    function clearOptionSelection(){
      document.querySelectorAll('#options-column .character-card').forEach(c=>c.classList.remove('selected'));
    }

    function handleOptionSelection(kana, card){
      if(!gameState.currentPair) return;

      clearOptionSelection();
      card.classList.add('selected');

      gameState.attempts++;
      updateStats();

      if(kana.romaji === gameState.currentPair.romaji){
        gameState.matchedPairs.push(kana.romaji);
        gameState.score += 10;
        gameState.matches++;
        showMessage('‚úì ¬°Perfecto! Ê≠£Ëß£ÔºÅ','success');
        playSuccessTone();

        const targetCard = document.getElementById('current-target-card');
        targetCard.classList.add('correct');
        card.classList.add('correct');

        setTimeout(()=>{
          targetCard.classList.remove('correct');
          clearOptionSelection();

          gameState.optionOrder = gameState.optionOrder.filter(k => k.romaji !== kana.romaji);
          renderOptions(gameState.optionOrder);

          advanceToNext();

          if(gameState.matches === gameState.totalPairs){
            setTimeout(()=>{
              showMessage('üéâ ¬°Completado! „Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ','success');
              stopTimer();
              renderCurrentTarget();
            }, 150);
          }
        }, 450);
      }else{
        gameState.score = Math.max(0, gameState.score - 2);
        card.classList.add('wrong');
        setTimeout(()=>{ card.classList.remove('wrong','selected'); }, 600);
        showMessage('‚úó ¬°Intenta de nuevo! „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÔºÅ','error');
      }

      updateStats();
    }

    function advanceToNext(){
      if(gameState.remainingPairs.length){
        gameState.remainingPairs.shift();
      }

      if(gameState.remainingPairs.length){
        gameState.currentPair = gameState.remainingPairs[0];
      }else{
        gameState.currentPair = null;
      }

      renderCurrentTarget();
      announceCurrentTarget();
    }

    function cycleCurrent(){
      if(!gameState.running) return;
      if(gameState.remainingPairs.length <= 1) return;

      const next = gameState.remainingPairs.shift();
      gameState.remainingPairs.push(next);
      gameState.currentPair = gameState.remainingPairs[0];
      clearOptionSelection();
      renderCurrentTarget();
      const config = MODE_CONFIG[gameState.mode];
      showMessage(config.cycleMessage);
      announceCurrentTarget();
    }

    function updateStats(){
      document.getElementById('score').textContent = gameState.score;
      document.getElementById('matches').textContent = gameState.matches;
      document.getElementById('attempts').textContent = gameState.attempts;
    }

    function showMessage(text,type=''){
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = 'message '+type;
    }

    // Flujo "Iniciar" (antes "Todos (46)") con cuenta regresiva
    function startAllMode(){
      resetAllStatsOnly();
      countdownThen(()=>{
        gameState.hasStarted = true;
        gameState.totalPairs = allKanaData.length;
        gameState.remainingPairs = shuffle(allKanaData);
        gameState.currentPair = gameState.remainingPairs[0] || null;
        gameState.optionOrder = shuffle(allKanaData);
        renderCurrentTarget();
        renderOptions(gameState.optionOrder);
        startTimer();
        const config = MODE_CONFIG[gameState.mode];
        showMessage(config.startMessage);
        announceCurrentTarget(true);
      });
    }

    // Cuenta regresiva 3-2-1-YA
    function countdownThen(cb){
      const overlay = document.getElementById('overlay');
      const label = document.getElementById('countdown');
      const steps = ['3','2','1','YA!'];
      let index = 0;

      clearCountdownTimers();
      overlay.classList.add('show');
      label.classList.remove('is-animating');
      label.textContent = steps[0];

      const runStep = ()=>{
        label.textContent = steps[index];
        label.classList.remove('is-animating');
        void label.offsetWidth;
        label.classList.add('is-animating');

        if(index < steps.length - 1){
          countdownTimeouts.push(setTimeout(()=>{
            index++;
            runStep();
          }, 800));
        }else{
          countdownTimeouts.push(setTimeout(()=>{
            overlay.classList.remove('show');
            label.classList.remove('is-animating');
            clearCountdownTimers();
            cb && cb();
          }, 650));
        }
      };

      countdownTimeouts.push(setTimeout(runStep, 20));
    }

    // Reset total (sin empezar juego)
    function resetAll(){
      resetAllStatsOnly();
      const config = MODE_CONFIG[gameState.mode];
      showMessage(`¬°Listo! Presiona "Iniciar" para jugar ${config.targetTitle} ‚áÑ ${config.optionsTitle}.`);
    }

    function resetAllStatsOnly(){
      stopTimer();
      clearCountdownTimers();
      if (speakTimeout) { clearTimeout(speakTimeout); speakTimeout = null; }
      if('speechSynthesis' in window){ speechSynthesis.cancel(); }
      gameState.currentPair = null;
      gameState.remainingPairs = [];
      gameState.optionOrder = [];
      gameState.matchedPairs = [];
      gameState.totalPairs = allKanaData.length;
      gameState.score = 0; gameState.matches = 0; gameState.attempts = 0;
      gameState.hasStarted = false;
      updateStats();
      renderOptions([]);
      renderCurrentTarget();
      document.getElementById('timer').textContent = '00:00.00';
      const overlay = document.getElementById('overlay');
      const label = document.getElementById('countdown');
      overlay.classList.remove('show');
      label.classList.remove('is-animating');
    }

    function updateModeToggle(){
      const btn = document.getElementById('modeToggleBtn');
      if(btn){
        const config = MODE_CONFIG[gameState.mode];
        btn.textContent = config.toggleLabel;
        btn.setAttribute('aria-label', `Modo actual: ${config.targetTitle} ‚Üí ${config.optionsTitle}. Haz clic para invertir.`);
        btn.title = `Modo actual: ${config.targetTitle} ‚Üí ${config.optionsTitle}. Haz clic para invertir.`;
      }
    }

    function toggleMode(){
      gameState.mode = gameState.mode === 'hiragana-to-katakana'
        ? 'katakana-to-hiragana'
        : 'hiragana-to-katakana';
      resetAllStatsOnly();
      updateModeToggle();
      showMessage('Modo cambiado. Presiona "Iniciar" para comenzar.');
    }

    // Mensaje inicial
    showMessage('Presiona "Iniciar" para comenzar con cuenta regresiva.');
    renderCurrentTarget();
    renderOptions([]);
    updateModeToggle();

    document.getElementById('skipBtn').addEventListener('click', cycleCurrent);
  </script>
</body>
</html>
